name: Tier 2 Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tier-2-tests:
    name: Tier 2 Shell Integration Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install Tier 1 shells (bash, zsh, fish)
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh fish

    - name: Install Tier 2 shells from apt
      run: |
        sudo apt-get install -y elvish xonsh

    - name: Install Nushell
      uses: hustcer/setup-nu@v3
      with:
        version: 'latest'

    - name: Install PowerShell
      run: |
        # Install prerequisites
        sudo apt-get install -y wget apt-transport-https software-properties-common

        # Download Microsoft repository GPG keys
        wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"

        # Register the Microsoft repository
        sudo dpkg -i packages-microsoft-prod.deb

        # Update apt and install PowerShell
        sudo apt-get update
        sudo apt-get install -y powershell

    - name: Install Oil Shell from source
      run: |
        # Install build dependencies
        sudo apt-get install -y build-essential libreadline-dev

        # Download and extract Oil Shell
        cd /tmp
        wget -q https://www.oilshell.org/download/oils-for-unix-0.24.0.tar.gz
        tar -xzf oils-for-unix-0.24.0.tar.gz
        cd oils-for-unix-0.24.0

        # Build and install to /usr/local
        ./configure
        _build/oils.sh
        sudo ./install

        # Verify installation
        which oil || which osh

    - name: Verify all shells are installed
      run: |
        echo "Checking shell installations..."
        which bash && bash --version | head -1
        which zsh && zsh --version
        which fish && fish --version
        which elvish && elvish --version
        which nu && nu --version
        which pwsh && pwsh --version
        which xonsh && xonsh --version
        which oil || which osh

    - name: Run tier-2 integration tests
      run: cargo test --test integration --features tier-2-integration-tests --verbose

    - name: Run all tests with tier-2 features
      run: cargo test --all --features tier-2-integration-tests
