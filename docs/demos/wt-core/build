#!/usr/bin/env python3
"""Build script for wt-core demo GIF.

This demo shows the core workflow with hooks:
1. wt list - see current worktrees with variety
2. wt switch - switch between worktrees
3. Show the post-start/pre-remove config
4. wt switch --create - create worktree with post-start running
5. wt list --full - show CI status
6. wt remove - remove worktree with pre-remove hook
"""

import sys
from pathlib import Path

# Add docs/demos/ to path for shared library
SCRIPT_DIR = Path(__file__).parent
DEMOS_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(DEMOS_DIR))

from shared import (
    DemoEnv, git, prepare_demo_repo,
    check_dependencies, setup_demo_output, build_shell_env, run_fish_script, record_all_themes,
)

REPO_ROOT = DEMOS_DIR.parent.parent
OUT_DIR = SCRIPT_DIR / "out"
TAPE_TEMPLATE = SCRIPT_DIR / "demo.tape"

OUTPUT_GIFS = {
    "light": OUT_DIR / "wt-core.gif",
    "dark": OUT_DIR / "wt-core-dark.gif",
}


def prepare_repo(env: DemoEnv):
    """Set up the demo repository with branches and worktrees."""
    hooks_config = '''[post-start]
dev = "npm run dev"

[pre-remove]
cleanup = "flyctl scale count 0"
'''
    prepare_demo_repo(env, REPO_ROOT, hooks_config=hooks_config)

    # Demo-specific: mock CLIs for hooks
    bin_dir = env.home / "bin"

    npm_mock = bin_dir / "npm"
    npm_mock.write_text("""#!/bin/bash
if [[ "$1" == "run" && "$2" == "dev" ]]; then
    echo ""
    echo "  VITE v5.4.2  ready in 342 ms"
    echo ""
    echo "  ➜  Local:   http://localhost:3000/"
    echo "  ➜  Network: http://192.168.1.42:3000/"
fi
""")
    npm_mock.chmod(0o755)

    flyctl_mock = bin_dir / "flyctl"
    flyctl_mock.write_text("""#!/bin/bash
if [[ "$1" == "scale" && "$2" == "count" && "$3" == "0" ]]; then
    echo "Scaling app to 0 machines"
fi
""")
    flyctl_mock.chmod(0o755)

    # Demo-specific: user config with approved commands
    config_dir = env.home / ".config" / "worktrunk"
    project_id = str(env.bare_remote).removesuffix(".git")
    (config_dir / "config.toml").write_text(f'''[projects."{project_id}"]
approved-commands = ["npm run dev", "flyctl scale count 0"]
''')

    # Add billing branch (at same commit as main = merged)
    create_branch_billing(env)


def create_branch_billing(env: DemoEnv):
    """Create billing branch that's already merged (at same commit as main)."""
    branch = "billing"
    path = env.work_base / f"acme.{branch}"
    git(["-C", str(env.repo), "worktree", "add", "-q", "-b", branch, str(path), "main"])
    git(["-C", str(path), "push", "-u", "origin", branch, "-q"])


def record_text(demo_env: DemoEnv):
    """Record text output by running demo commands."""
    commands = [
        "wt list",
        "wt switch alpha",
        "cat .config/wt.toml",
        "wt switch --create api",
        "wt list --full",
        "wt switch billing",
        "wt remove",
    ]

    env = build_shell_env(demo_env, REPO_ROOT)
    script = "\n".join(f"echo '$ {cmd}'\n{cmd}\necho ''" for cmd in commands)
    output = run_fish_script(demo_env, script, env)
    (OUT_DIR / "run.txt").write_text(output)


def main():
    check_dependencies(["wt", "vhs", "starship", "bat"])
    setup_demo_output(OUT_DIR)

    # Create separate environments for text and VHS recording
    text_env = DemoEnv(name="text", out_dir=OUT_DIR, repo_name="acme")
    vhs_env = DemoEnv(name="vhs", out_dir=OUT_DIR, repo_name="acme")

    prepare_repo(text_env)
    record_text(text_env)

    prepare_repo(vhs_env)
    record_all_themes(vhs_env, TAPE_TEMPLATE, OUTPUT_GIFS, REPO_ROOT)

    print(f"\nText log saved to {OUT_DIR / 'run.txt'}")


if __name__ == "__main__":
    main()
