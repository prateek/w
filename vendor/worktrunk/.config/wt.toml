[post-start]
# Copy target/ from main worktree using CoW (~3s vs ~68s full rebuild)
deps = "wt step copy-ignored"
assets = "task fetch-assets"
docs = "cd docs && zola serve -p {{ branch | hash_port }}"

[post-merge]
build = "cargo build --all-targets"
install = "cargo install --path ."
sync = 'if [ "{{ target }}" = "main" ]; then git pull && git push; fi'

[pre-merge]
pre-commit = "if [ -n \"$MSYSTEM\" ]; then SKIP=lychee-system pre-commit run --all-files; else pre-commit run --all-files; fi"
insta = "RUSTFLAGS='-D warnings' NEXTEST_NO_INPUT_HANDLER=1 cargo insta test --test-runner nextest --dnd --check $([ \"$(uname)\" = 'Linux' ] && echo '--unreferenced reject') --features shell-integration-tests"
doctest = "RUSTDOCFLAGS='-Dwarnings' cargo test --doc"
doc = "RUSTDOCFLAGS='-Dwarnings' cargo doc --no-deps"

[list]
url = "http://127.0.0.1:{{ branch | hash_port }}"

[post-remove]
docs = "lsof -ti :{{ branch | hash_port }} -sTCP:LISTEN | xargs kill 2>/dev/null || true"
